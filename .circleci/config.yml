version: 2.1
executors:
  default:
    working_directory: ~/sample
    docker:
      - image: yamashun/ruby:2.5.3
commands:
  echo-test:
    steps:
      - run:
          name: echo test
          command: echo 'test'
  echo-deploy:
    steps:
      - run:
          name: echo deploy
          command: echo 'deploy'
jobs:
  test-job:
    executor:
      name: default
    steps:
      - checkout
      - run:
          name: test_step
          command: |
            if [ -z "`git log -1 --oneline | grep skip_test`" ]; then
              echo "execute test job"
            else
              echo "skip test job"
            fi
  deploy-job:
    executor:
      name: default
    steps:
      - run:
          name: deploy_step
          command: echo 'execute deploy step'
workflows:
  test:
    jobs:
      - test-job:
          pre-steps:
              - echo-test
          filters:
            branches:
              ignore: ci_workflow_master
  deploy:
    jobs:
      - test-job:
          pre-steps:
            - echo-deploy
          filters:
            tags:
              only: /^(?=.*)(?!.*skiptest).*$/
            branches:
              ignore: /.*/
      - deploy-job:
          requires:
            - test-job
          filters:
            tags:
              only: /.*/
            branches:
              ignore: /.*/
